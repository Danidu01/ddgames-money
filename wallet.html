<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wallet - DD-Games Money</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 2rem 0;
            /* --- Background Image Styles --- */
            background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT0P4l4azF5XCuejb9u8t7PPnHfEGItqZNZMA&s');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .container {
            background-color: rgba(30, 30, 30, 0.9);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            width: 400px;
            text-align: center;
        }
        .container h1 { margin-top: 0; color: #4CAF50; }
        
        .wallet-info { text-align: left; margin-bottom: 2rem; }
        .wallet-info p { font-size: 1.1rem; margin: 0.5rem 0; background-color: rgba(42, 42, 42, 0.9); padding: 0.75rem; border-radius: 4px; }
        .wallet-info strong { color: #4CAF50; min-width: 120px; display: inline-block; }

        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input { width: 100%; padding: 0.75rem; box-sizing: border-box; border: 1px solid #333; border-radius: 4px; background-color: #333; color: #ffffff; }
        
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; background-color: #4CAF50; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; box-sizing: border-box; width: 100%; margin-top: 0.5rem; }
        .btn:hover { background-color: #45a049; }
        
        .btn-logout { background-color: #f44336; float: right; margin-top: 0; width: auto; }
        .btn-logout:hover { background-color: #d32f2f; }
        
        .btn-buy { background-color: #007bff; }
        .btn-buy:hover { background-color: #0069d9; }
        .btn-buy:disabled { background-color: #5a6268; cursor: not-allowed; }

        .btn-game-runner { background-color: #ffc107; color: #121212; }
        .btn-game-runner:hover { background-color: #e0a800; }
        .btn-game-fight { background-color: #dc3545; }
        .btn-game-fight:hover { background-color: #c82333; }
        
        .btn-withdraw { background-color: #17a2b8; }
        .btn-withdraw:hover { background-color: #138496; }


        #message, #reload-message, #buy-tickets-message, #withdraw-message { margin-top: 1rem; font-size: 0.9rem; min-height: 20px; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }

        .section {
            background-color: rgba(42, 42, 42, 0.9);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }
        
        /* Payment Instructions Styles */
        #payment-instructions {
            display: none; /* මුලින් සඟවා තබයි */
            text-align: left;
            background-color: #1a1a1a;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #ffc107;
        }
        #payment-instructions p { font-size: 0.9rem; }
        #payment-instructions strong { color: #ffc107; }
        #confirm-payment-btn { background-color: #ffc107; color: #121212; }
        #confirm-payment-btn:hover { background-color: #e0a800; }

        /* (අලුත්) Withdrawal Section Styles */
        #withdraw-section {
            display: none; /* Balance එක 100,000 වන තෙක් සඟවා තබයි */
            background-color: #1a1a1a;
            border: 1px solid #17a2b8;
        }
        #withdraw-section h3 { color: #17a2b8; }

    </style>
</head>
<body>
    <div class="container">
        <button id="logout-btn" class="btn btn-logout">Logout</button>
        <h1>My Wallet</h1>
        
        <div class="wallet-info">
            <p><strong>Account Name:</strong> <span id="account-name">Loading...</span></p>
            <p><strong>Account Number:</strong> <span id="account-number">Loading...</span></p>
            <p><strong>Balance:</strong> LKR <span id="balance">0.00</span></p>
            <p><strong>Tickets:</strong> <span id="tickets">0</span></p>
        </div>

        <!-- Reload Section (Simulation) -->
        <div class="section">
            <form id="reload-form">
                <h3>Reload Your Account</h3>
                <div class="form-group">
                    <label for="amount">Amount (LKR)</label>
                    <input type="number" id="amount" placeholder="e.g., 500" required>
                </div>
                <button type="submit" class="btn">Reload Now</button>
                <div id="reload-message"></div>
            </form>
            
            <!-- Payment Instructions Panel -->
            <div id="payment-instructions">
                <p><strong>Payment Instructions</strong></p>
                <p>Please eZ Cash / mCash the amount <strong id="payment-amount">LKR 0.00</strong> to:</p>
                <p>Owner's Number: <strong>0704966651</strong></p>
                <p>IMPORTANT: Use your Account Number <strong id="payment-account-number"></strong> as the reference/memo.</p>
                <button id="confirm-payment-btn" class="btn">I have completed the payment</button>
            </div>
        </div>

        <!-- Buy Tickets Section -->
        <div class="section">
            <h3>Buy Tickets</h3>
            <p>Cost: LKR 500.00 = 5 Tickets</p>
            <button id="buy-tickets-btn" class="btn btn-buy">Buy 5 Tickets</button>
            <div id="buy-tickets-message"></div>
        </div>
        
        <!-- Play Games Section -->
        <div class="section">
            <h3>Play Games</h3>
            <button id="games-btn" class="btn btn-game-runner">Play Endless Runner (Earn Tickets)</button>
            <button id="fight-game-btn" class="btn btn-game-fight">Play Fight Game (Bet Money)</button>
        </div>
        
        <!-- (අලුත්) Withdrawal Section -->
        <div id="withdraw-section" class="section">
             <h3>Congratulations!</h3>
             <p>You've reached LKR 100,000! Withdraw your LKR 100 reward.</p>
             <form id="withdraw-form">
                <div class="form-group">
                    <label for="phone-number">Your Phone Number (for Reload)</label>
                    <input type="tel" id="phone-number" placeholder="e.g., 0771234567" required>
                </div>
                <button type="submit" class="btn btn-withdraw">Withdraw LKR 100</button>
             </form>
             <div id="withdraw-message"></div>
        </div>

    </div>

    <script>
        // --- Setup ---
        const token = localStorage.getItem('ddUserToken');
        const authHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };

        // --- UI Elements ---
        const accountNameEl = document.getElementById('account-name');
        const accountNumberEl = document.getElementById('account-number');
        const balanceEl = document.getElementById('balance');
        const ticketsEl = document.getElementById('tickets');
        const reloadForm = document.getElementById('reload-form');
        const reloadAmountInput = document.getElementById('amount');
        const reloadMessageEl = document.getElementById('reload-message');
        const buyTicketsBtn = document.getElementById('buy-tickets-btn');
        const buyTicketsMessageEl = document.getElementById('buy-tickets-message');
        const paymentInstructionsEl = document.getElementById('payment-instructions');
        const paymentAmountEl = document.getElementById('payment-amount');
        const paymentAccountNumberEl = document.getElementById('payment-account-number');
        const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
        
        // (අලුත්) Withdrawal Elements
        const withdrawSection = document.getElementById('withdraw-section');
        const withdrawForm = document.getElementById('withdraw-form');
        const phoneNumberInput = document.getElementById('phone-number');
        const withdrawMessageEl = document.getElementById('withdraw-message');

        let amountToReload = 0;
        const WITHDRAW_THRESHOLD = 100000; // LKR 100,000

        // --- 1. Page Load: User Data ගෙන්වා ගැනීම ---
        window.addEventListener('DOMContentLoaded', async () => {
            if (!token) { window.location.href = '/login.html'; return; }
            try {
                const response = await fetch('/api/user-data', { method: 'GET', headers: authHeaders });
                if (response.ok) {
                    const data = await response.json();
                    updateWalletUI(data.balance, data.tickets);
                    accountNameEl.textContent = data.accountName;
                    accountNumberEl.textContent = data.accountNumber;
                    paymentAccountNumberEl.textContent = data.accountNumber;
                } else {
                    localStorage.removeItem('ddUserToken');
                    window.location.href = '/login.html';
                }
            } catch (error) { console.error('Error fetching user data:', error); }
        });

        // (අලුත්) Wallet UI සහ Withdraw පුවරුව පාලනය කිරීමේ Function එක
        function updateWalletUI(balance, tickets) {
            balanceEl.textContent = parseFloat(balance).toFixed(2);
            ticketsEl.textContent = tickets;
            
            // Balance එක 100,000 ට වැඩි නම් Withdraw පුවරුව පෙන්වීම
            if (balance >= WITHDRAW_THRESHOLD) {
                withdrawSection.style.display = 'block';
            } else {
                withdrawSection.style.display = 'none';
            }
        }

        // --- 2. Reload Form එක submit කිරීම (Simulation Part 1) ---
        reloadForm.addEventListener('submit', (event) => {
            event.preventDefault();
            amountToReload = Number(reloadAmountInput.value);
            if (amountToReload <= 0) {
                showMessage(reloadMessageEl, 'Reload amount must be greater than 0.', 'error');
                return;
            }
            paymentAmountEl.textContent = `LKR ${amountToReload.toFixed(2)}`;
            reloadForm.style.display = 'none';
            paymentInstructionsEl.style.display = 'block';
            showMessage(reloadMessageEl, 'Please follow the payment instructions below.', '');
        });

        // --- 3. Payment එක තහවුරු කිරීම (Simulation Part 2) ---
        confirmPaymentBtn.addEventListener('click', async () => {
            showMessage(reloadMessageEl, 'Verifying payment and reloading...', '');
            try {
                const response = await fetch('/api/reload', {
                    method: 'POST',
                    headers: authHeaders,
                    body: JSON.stringify({ amount: amountToReload })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(reloadMessageEl, data.message, 'success');
                    updateWalletUI(data.newBalance, ticketsEl.textContent); // Update UI
                    reloadAmountInput.value = '';
                    paymentInstructionsEl.style.display = 'none';
                    reloadForm.style.display = 'block';
                    amountToReload = 0;
                } else {
                    showMessage(reloadMessageEl, `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage(reloadMessageEl, 'Could not connect to the server.', 'error');
            }
        });

        // --- 4. Buy Tickets බොත්තම click කිරීම ---
        buyTicketsBtn.addEventListener('click', async () => {
            const cost = 500;
            const currentBalance = parseFloat(balanceEl.textContent);
            if (currentBalance < cost) {
                showMessage(buyTicketsMessageEl, 'Not enough balance to buy tickets!', 'error');
                return;
            }
            if (!confirm("Are you sure you want to spend LKR 500.00 for 5 tickets?")) {
                return;
            }
            showMessage(buyTicketsMessageEl, 'Purchasing tickets...', '');
            buyTicketsBtn.disabled = true;

            try {
                const response = await fetch('/api/buy-tickets', { method: 'POST', headers: authHeaders });
                const data = await response.json();
                if (response.ok) {
                    showMessage(buyTicketsMessageEl, data.message, 'success');
                    updateWalletUI(data.newBalance, data.newTicketCount); // Update UI
                } else {
                    showMessage(buyTicketsMessageEl, `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage(buyTicketsMessageEl, 'Could not connect to the server.', 'error');
            }
            buyTicketsBtn.disabled = false;
        });
        
        // --- 5. (අලුත්) Withdrawal Form එක submit කිරීම ---
        withdrawForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const phoneNumber = phoneNumberInput.value;
            if (!phoneNumber || phoneNumber.length < 9) {
                showMessage(withdrawMessageEl, 'Please enter a valid phone number.', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to withdraw LKR 100 to ${phoneNumber}? This will deduct LKR 100,000 from your balance.`)) {
                return;
            }
            
            showMessage(withdrawMessageEl, 'Submitting withdrawal request...', '');
            
            try {
                const response = await fetch('/api/withdraw', {
                    method: 'POST',
                    headers: authHeaders,
                    body: JSON.stringify({ phoneNumber: phoneNumber })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(withdrawMessageEl, data.message, 'success');
                    updateWalletUI(data.newBalance, ticketsEl.textContent); // Update UI
                    phoneNumberInput.value = '';
                } else {
                    showMessage(withdrawMessageEl, `Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage(withdrawMessageEl, 'Could not connect to the server.', 'error');
            }
        });

        // --- 6. Navigation ---
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('ddUserToken');
            window.location.href = '/login.html';
        });
        document.getElementById('games-btn').addEventListener('click', () => {
            window.location.href = '/games.html';
        });
        document.getElementById('fight-game-btn').addEventListener('click', () => {
            window.location.href = '/fight-game.html';
        });

        // Helper Function
        function showMessage(element, msg, type) {
            element.textContent = msg;
            element.className = type; 
        }
    </script>
</body>
</html>
