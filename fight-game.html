<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fight Game - DD-Games Money</title>
    <style>
        /* CSS styles (Final Version) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            /* Background Image */
            background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT0P4l4azF5XCuejb9u8t7PPnHfEGItqZNZMA&s');
            background-size: cover;
            background-position: center;
        }
        .container {
            background-color: rgba(30, 30, 30, 0.9);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            width: 90vw;
            max-width: 450px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .container h1 {
            margin-top: 0;
            color: #dc3545; /* Red for Fight Game */
        }
        
        /* Game UI sections */
        .game-section {
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            background-color: rgba(42, 42, 42, 0.8);
        }
        
        /* Bet Section */
        #bet-section {
            display: block; /* Show by default */
        }
        
        /* Game Play Section */
        #game-play-section {
            display: none; /* Hide by default */
        }
        
        /* Animation Section */
        #animation-section {
            display: none; /* Hide by default */
            font-size: 3rem;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* CSS Keyframe Animation for "shake" */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        .shaking {
            animation: shake 0.5s linear infinite;
        }
        
        /* Move Selection */
        .moves {
            margin-top: 1rem;
            display: flex;
            justify-content: space-around;
        }
        .move-btn {
            font-size: 3rem;
            background: none;
            border: 2px solid #ffc107;
            color: #ffc107;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .move-btn:hover {
            background-color: #ffc107;
            color: #121212;
            transform: scale(1.1);
        }
        
        /* Result Display */
        #result-display {
            text-align: center;
            margin-top: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input { 
            width: 100%; 
            padding: 0.75rem; 
            box-sizing: border-box; 
            border: 1px solid #333; 
            border-radius: 4px; 
            background-color: #333; 
            color: #ffffff; 
        }
        
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; background-color: #dc3545; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; margin: 0.5rem; width: 100%; box-sizing: border-box; }
        .btn:hover { background-color: #c82333; }
        .btn-nav { background-color: #6c757d; }
        .btn-nav:hover { background-color: #5a6268; }
        
        #message, #game-message { 
            margin-top: 1rem; 
            font-size: 1.1rem; 
            font-weight: bold; 
            min-height: 20px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fight Game (Betting)</h1>
        <p>Your Tickets: <strong id="ticket-count">Loading...</strong> | Your Balance: LKR <strong id="balance">Loading...</strong></p>
        
        <!-- Bet Section -->
        <div id="bet-section" class="game-section">
            <h3>Place Your Bet</h3>
            <p>Costs 1 Ticket to play.</p>
            <form id="bet-form">
                <div class="form-group">
                    <label for="bet-amount">Bet Amount (LKR)</label>
                    <input type="number" id="bet-amount" placeholder="e.g., 100" min="10" required>
                </div>
                <button type="submit" class="btn">Place Bet & Start Game</button>
            </form>
            <div id="message"></div>
            <button id="wallet-btn" class="btn btn-nav" style="margin-top: 20px;">Go to Wallet</button>
        </div>
        
        <!-- Game Play Section -->
        <div id="game-play-section" class="game-section">
            <!-- Animation Div -->
            <div id="animation-section">
                <span>‚úä</span>
                <span>‚úã</span>
                <span>‚úåÔ∏è</span>
            </div>
            
            <h3>Make Your Move!</h3>
            <div class="moves">
                <button class="move-btn" data-move="rock">‚úä</button>
                <button class="move-btn" data-move="paper">‚úã</button>
                <button class="move-btn" data-move="scissors">‚úåÔ∏è</button>
            </div>
            <div id="result-display"></div>
            <div id="game-message"></div>
        </div>
        
    </div>

    <script>
        // --- 1. Global Variables & Auth ---
        const token = localStorage.getItem('ddUserToken');
        const authHeaders = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };
        
        // Element cache
        const messageEl = document.getElementById('message');
        const gameMessageEl = document.getElementById('game-message');
        const ticketCountEl = document.getElementById('ticket-count');
        const balanceEl = document.getElementById('balance');
        
        const betSectionEl = document.getElementById('bet-section');
        const gamePlaySectionEl = document.getElementById('game-play-section');
        const betFormEl = document.getElementById('bet-form');
        
        const animationSectionEl = document.getElementById('animation-section');
        const resultDisplayEl = document.getElementById('result-display');
        
        let currentBetAmount = 0;

        // --- 2. Initial Data Load ---
        window.addEventListener('DOMContentLoaded', async () => {
            if (!token) {
                window.location.href = '/login.html'; // (Fixed Path)
                return;
            }
            
            // Fetch user data
            try {
                // (Fixed Path)
                const response = await fetch('/api/user-data', {
                    method: 'GET', headers: authHeaders
                });
                if (response.ok) {
                    const data = await response.json();
                    updateUI(data.tickets, data.balance);
                } else {
                    localStorage.removeItem('ddUserToken');
                    window.location.href = '/login.html'; // (Fixed Path)
                }
            } catch (error) { 
                messageEl.className = 'error';
                messageEl.textContent = 'Error loading user data.';
            }
        });
        
        // --- 3. UI Update Function ---
        function updateUI(tickets, balance) {
            ticketCountEl.textContent = tickets;
            balanceEl.textContent = parseFloat(balance).toFixed(2);
        }

        // --- 4. Bet Form Submit ---
        betFormEl.addEventListener('submit', async (event) => {
            event.preventDefault();
            const betAmountInput = document.getElementById('bet-amount');
            currentBetAmount = Number(betAmountInput.value);
            
            if (currentBetAmount <= 0) {
                messageEl.className = 'error';
                messageEl.textContent = 'Please enter a valid bet amount.';
                return;
            }
            
            messageEl.textContent = 'Spending 1 ticket and placing bet...';
            
            // --- Step A: Spend 1 Ticket ---
            try {
                // (Fixed Path)
                const spendResponse = await fetch('/api/spend-ticket', {
                    method: 'POST', headers: authHeaders
                });
                const spendData = await spendResponse.json();

                if (!spendResponse.ok) {
                    messageEl.className = 'error';
                    messageEl.textContent = `Error: ${spendData.message}`;
                    return;
                }
                
                // Ticket spent, now check balance for bet
                if (parseFloat(balanceEl.textContent) < currentBetAmount) {
                    messageEl.className = 'error';
                    messageEl.textContent = 'Not enough balance for this bet!';
                    // (Note: Ticket is already spent)
                    return;
                }
                
                // All checks passed! Start the game.
                messageEl.textContent = 'Ticket spent! Get ready...';
                updateUI(spendData.newTicketCount, balanceEl.textContent); // Update ticket count
                
                // Switch to game UI
                betSectionEl.style.display = 'none';
                gamePlaySectionEl.style.display = 'block';
                
                // Start animation
                animationSectionEl.style.display = 'flex';
                animationSectionEl.classList.add('shaking');
                resultDisplayEl.textContent = 'Get Ready to Fight!';
                gameMessageEl.textContent = '';
                
                // Stop animation after 3 seconds and show moves
                setTimeout(() => {
                    animationSectionEl.style.display = 'none';
                    animationSectionEl.classList.remove('shaking');
                    resultDisplayEl.textContent = 'Make Your Move!';
                }, 3000); // 3 seconds

            } catch (error) {
                messageEl.className = 'error';
                messageEl.textContent = 'Could not connect to the server.';
            }
        });
        
        // --- 5. Game Logic (Rock, Paper, Scissors) ---
        document.querySelectorAll('.move-btn').forEach(button => {
            button.addEventListener('click', () => {
                const playerMove = button.getAttribute('data-move');
                const moves = ['rock', 'paper', 'scissors'];
                const computerMove = moves[Math.floor(Math.random() * 3)];
                
                const result = getGameResult(playerMove, computerMove);
                
                let resultText = '';
                let won = false;
                
                if (result === 'win') {
                    resultText = `You Won! üèÜ (You: ${playerMove}, CPU: ${computerMove})`;
                    won = true;
                } else if (result === 'lose') {
                    resultText = `You Lost! üòû (You: ${playerMove}, CPU: ${computerMove})`;
                    won = false;
                } else {
                    resultText = `It's a Tie! ü§ù (You: ${playerMove}, CPU: ${computerMove})`;
                    // Tie logic - no money exchanged, return to bet screen
                    resultDisplayEl.textContent = resultText;
                    gameMessageEl.textContent = 'No money lost. Returning to bet screen...';
                    setTimeout(resetGame, 2000);
                    return;
                }
                
                resultDisplayEl.textContent = resultText;
                
                // Disable buttons
                document.querySelectorAll('.move-btn').forEach(btn => btn.disabled = true);
                
                // Process the bet result with the backend
                processBetResult(currentBetAmount, won);
            });
        });

        // --- 6. Process Bet Result (Backend Call) ---
        async function processBetResult(betAmount, didWin) {
            gameMessageEl.textContent = 'Processing bet result...';
            
            try {
                // (Fixed Path)
                const response = await fetch('/api/fight-bet', {
                    method: 'POST',
                    headers: authHeaders,
                    body: JSON.stringify({ betAmount: betAmount, won: didWin })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    gameMessageEl.className = didWin ? 'success' : 'error';
                    gameMessageEl.textContent = data.message;
                    updateUI(ticketCountEl.textContent, data.newBalance); // Update balance
                } else {
                    gameMessageEl.className = 'error';
                    gameMessageEl.textContent = `Error: ${data.message}`;
                }
                
            } catch (error) {
                gameMessageEl.className = 'error';
                gameMessageEl.textContent = 'Could not connect to the server.';
            } finally {
                // Return to bet screen after 3 seconds
                setTimeout(resetGame, 3000);
            }
        }
        
        // --- 7. Helper Functions ---
        function getGameResult(player, computer) {
            if (player === computer) return 'tie';
            if (
                (player === 'rock' && computer === 'scissors') ||
                (player === 'paper' && computer === 'rock') ||
                (player === 'scissors' && computer === 'paper')
            ) {
                return 'win';
            }
            return 'lose';
        }
        
        function resetGame() {
            // Reset UI to bet screen
            betSectionEl.style.display = 'block';
            gamePlaySectionEl.style.display = 'none';
            messageEl.textContent = '';
            gameMessageEl.textContent = '';
            resultDisplayEl.textContent = '';
            document.getElementById('bet-amount').value = '';
            document.querySelectorAll('.move-btn').forEach(btn => btn.disabled = false);
            currentBetAmount = 0;
        }

        // --- 8. Go to Wallet Button ---
        document.getElementById('wallet-btn').addEventListener('click', () => {
            window.location.href = '/wallet.html'; // (Fixed Path)
        });

    </script>
</body>
</html>
