<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Game - DD-Games Money</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden; /* Stop scrollbars */
            /* Background Image */
            background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT0P4l4azF5XCuejb9u8t7PPnHfEGItqZNZMA&s');
            background-size: cover;
            background-position: center;
        }
        .container {
            background-color: rgba(30, 30, 30, 0.9); /* Semi-transparent background */
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            width: 90vw;
            max-width: 600px; /* Game එකට වැඩි ඉඩක් */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .container h1 {
            margin-top: 0;
            color: #ffc107;
        }
        
        /* Game styles */
        #game-container {
            width: 100%;
            height: 400px; /* Game Canvas එකේ උස */
            background-color: #000;
            margin-top: 1rem;
            border-radius: 8px;
            overflow: hidden;
            display: none; /* --- මුලින් සඟවා තබයි --- */
            position: relative; /* Score එක උඩින් පෙන්වීමට */
        }
        #game-canvas {
            width: 100%;
            height: 100%;
        }
        #score-display {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffc107;
            background-color: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
        /* (අලුත්) Game Over UI */
        #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Hide initially */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 20;
            font-size: 3rem;
            font-weight: bold;
            color: #f44336;
            text-shadow: 2px 2px 8px #000;
        }
        #game-over-screen small {
            font-size: 1.2rem;
            color: #fff;
            margin-top: 10px;
        }


        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; margin: 0.5rem; }
        .btn:hover { background-color: #0069d9; }
        .btn-nav { background-color: #6c757d; }
        .btn-nav:hover { background-color: #5a6268; }
        .btn-girl { background-color: #e91e63; } /* Pink for girl */
        .btn-girl:hover { background-color: #c2185b; }
        
        #message { margin-top: 1rem; font-size: 1.1rem; font-weight: bold; min-height: 20px; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
    </style>
    <!-- Three.js Library එක load කිරීම -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- (අලුත්) Tone.js Library (ශබ්ද සඳහා) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- (අලුත්) Character Selection UI -->
        <div id="character-select">
            <h1>Endless Runner Game</h1>
            <p>Your Tickets: <strong id="ticket-count">Loading...</strong></p>
            <h3>Select Your Character</h3>
            <button id="select-boy" class="btn">Play as Boy (Blue)</button>
            <button id="select-girl" class_name="btn btn-girl">Play as Girl (Pink)</button>
            <div id="message"></div>
            <button id="wallet-btn" class="btn btn-nav" style="margin-top: 20px;">Go to Wallet</button>
        </div>

        <!-- The Actual Game Area -->
        <div id="game-container">
            <canvas id="game-canvas"></canvas>
            <div id="score-display">Score: 0</div>
            <!-- (අලුත්) Game Over Screen -->
            <div id="game-over-screen">
                GAME OVER
                <small id="game-over-score"></small>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('ddUserToken');
        const authHeaders = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };
        
        const messageEl = document.getElementById('message');
        const ticketCountEl = document.getElementById('ticket-count');
        const gameContainerEl = document.getElementById('game-container');
        const scoreDisplayEl = document.getElementById('score-display').firstChild;
        const walletBtn = document.getElementById('wallet-btn');
        
        // (අලුත්) UI Elements
        const characterSelectEl = document.getElementById('character-select');
        const selectBoyBtn = document.getElementById('select-boy');
        const selectGirlBtn = document.getElementById('select-girl');
        const gameOverScreenEl = document.getElementById('game-over-screen');
        const gameOverScoreEl = document.getElementById('game-over-score');

        let currentGameScore = 0;
        let isGameOver = false;
        let playerColor = '#007bff'; // Default 'Boy' color

        // (අලුත්) Sound Synths
        let bgMusic, gameOverSound;

        // --- 1. පිටුව load වූ සැණින් Ticket ගණන ගෙන්වා ගැනීම ---
        window.addEventListener('DOMContentLoaded', async () => {
            if (!token) { window.location.href = '/login.html'; return; }
            
            // Sound engine එක user interaction එකක් සඳහා සූදානම් කිරීම
            await Tone.start();
            
            // Sound effects නිර්මාණය කිරීම
            bgMusic = new Tone.Loop(time => {
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C2", "8n", time);
                synth.triggerAttackRelease("G2", "8n", time + 0.5);
            }, "1n");
            
            gameOverSound = new Tone.Synth().toDestination();

            // User data ගෙන්වා ගැනීම
            try {
                const response = await fetch('/api/user-data', {
                    method: 'GET', headers: authHeaders
                });
                if (response.ok) {
                    const data = await response.json();
                    ticketCountEl.textContent = data.tickets;
                } else {
                    localStorage.removeItem('ddUserToken');
                    window.location.href = '/login.html';
                }
            } catch (error) { console.error('Error fetching user data:', error); }
        });

        // --- 2. Character Selection ---
        selectBoyBtn.addEventListener('click', () => {
            playerColor = '#007bff'; // නිල්
            spendTicketAndStartGame();
        });
        selectGirlBtn.addEventListener('click', () => {
            playerColor = '#e91e63'; // රෝස
            spendTicketAndStartGame();
        });

        // --- 3. "Play Game" (Ticket වියදම් කිරීම) ---
        async function spendTicketAndStartGame() {
            messageEl.textContent = 'Spending 1 ticket...';
            
            try {
                const response = await fetch('/api/spend-ticket', {
                    method: 'POST', headers: authHeaders
                });
                const data = await response.json();

                if (response.ok) {
                    messageEl.className = 'success';
                    messageEl.textContent = data.message;
                    ticketCountEl.textContent = data.newTicketCount;
                    
                    // --- ක්‍රීඩාව ආරම්භ කිරීම ---
                    startGame();
                } else {
                    messageEl.className = 'error';
                    messageEl.textContent = `Error: ${data.message}`;
                }
            } catch (error) {
                messageEl.className = 'error';
                messageEl.textContent = 'Could not connect to the server.';
            }
        }

        // --- 4. ක්‍රීඩාව ආරම්භ කිරීමේ Function එක ---
        function startGame() {
            currentGameScore = 0;
            isGameOver = false;
            gameSpeed = 0.05; // Speed එක reset කිරීම
            scoreDisplayEl.textContent = 'Score: 0';
            
            // UI එක වෙනස් කිරීම
            characterSelectEl.style.display = 'none'; // Character select සඟවා තැබීම
            gameContainerEl.style.display = 'block'; // Game එක පෙන්වීම
            gameOverScreenEl.style.display = 'none'; // Game Over තිරය සඟවා තැබීම

            messageEl.textContent = ''; // පරණ message මකා දැමීම
            
            // 3D Game Logic එක ආරම්භ කිරීම
            init3DGame(playerColor);
            
            // Background music එක පටන් ගැනීම
            Tone.Transport.start();
            bgMusic.start(0);
        }

        // --- 5. Wallet එකට යෑම ---
        walletBtn.addEventListener('click', () => {
            window.location.href = '/wallet.html';
        });

        // --- 6. (වෙනස් කළ) Game Over (බාධකයක වැදුනොත්) ---
        function triggerGameOver() {
            if (isGameOver) return; // දැනටමත් game over නම් නැවත නොකිරීම
            isGameOver = true;
            
            // Sound නැවැත්වීම සහ Game Over sound එක play කිරීම
            bgMusic.stop();
            Tone.Transport.stop();
            gameOverSound.triggerAttackRelease("C3", "0.5s");
            gameOverSound.triggerAttackRelease("G2", "0.5s", "+0.1s");
            gameOverSound.triggerAttackRelease("C2", "1s", "+0.2s");
            
            // Game Over UI එක පෙන්වීම
            gameOverScoreEl.textContent = `Final Score: ${currentGameScore}`;
            gameOverScreenEl.style.display = 'flex'; // පෙන්වීම
            
            // (අලුත්) Score එක Wallet Balance එකට එකතු කිරීම
            if (currentGameScore > 0) {
                postScoreToWallet(currentGameScore);
            } else {
                 messageEl.textContent = 'Game Over!';
            }

            // තත්පර 3කට පසු Character Select තිරයට යොමු කිරීම
            setTimeout(() => {
                characterSelectEl.style.display = 'block';
                gameContainerEl.style.display = 'none';
                // Ticket ගණන update කිරීම (වියදම් කළ එක)
                window.location.reload(); // සරලම ක්‍රමය
            }, 3000);
        }

        // --- 7. (අලුත්) Score එක Wallet Balance එකට එකතු කිරීම ---
        async function postScoreToWallet(score) {
            messageEl.className = 'success';
            messageEl.textContent = `Game Over! Adding ${score} coins to your wallet balance...`;

            try {
                // '/api/reload' endpoint එක re-use කිරීම
                const response = await fetch('/api/reload', {
                    method: 'POST',
                    headers: authHeaders,
                    body: JSON.stringify({ amount: score }) // Score එක amount එක ලෙස යැවීම
                });
                const data = await response.json();

                if (response.ok) {
                    gameOverScoreEl.textContent = `Final Score: ${score}. Added to wallet!`;
                    messageEl.textContent = `Successfully added ${score} coins to your balance.`;
                } else {
                    messageEl.textContent = `Error: ${data.message}`;
                }
            } catch (error) {
                messageEl.className = 'error';
                messageEl.textContent = 'Could not save score to wallet.';
            }
        }


        // ******************************************************
        // --- 8. THREE.JS 3D GAME LOGIC (යාවත්කාලීන කළ) ---
        // ******************************************************
        let scene, camera, renderer, player, lanes, obstacles, coins, laneMarkers, buildings;
        const lanePositions = [-2, 0, 2]; // වම්, මැද, දකුණු (ඉඩ වැඩි කළා)
        let currentLane = 1; // 0=වම්, 1=මැද, 2=දකුණු

        function init3DGame(selectedPlayerColor) {
            // පරණ scene එක (ඇත්නම්) පිරිසිදු කිරීම
            if (renderer) {
                renderer.dispose();
                scene.traverse(obj => {
                    if (obj.geometry) obj.geometry.dispose();
                    if (obj.material) obj.material.dispose();
                });
            }

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2a); // රාත්‍රී අහස
            scene.fog = new THREE.Fog(0x1a1a2a, 10, 30); // දුරස්ථ බව පෙන්වීමට

            // Camera
            camera = new THREE.PerspectiveCamera(75, gameContainerEl.clientWidth / gameContainerEl.clientHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 4); // x, y, z (කලින් 0, 2, 5)
            camera.lookAt(0, 1, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game-canvas'), antialias: true });
            renderer.setSize(gameContainerEl.clientWidth, gameContainerEl.clientHeight);

            // Light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(2, 5, 5);
            scene.add(dirLight);
            
            // (අලුත්) Player ගේ Headlights
            const headLight = new THREE.SpotLight(0xffffff, 1, 20, Math.PI / 4, 0.5);
            headLight.position.set(0, 0.5, 3.5);
            headLight.target = player;
            scene.add(headLight);

            // Ground (Highway)
            const groundGeo = new THREE.PlaneGeometry(10, 100);
            const groundMat = new THREE.MeshStandardMaterial({ color: 0x333333 }); // අළු පාර
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.5;
            scene.add(ground);

            // (අලුත්) Lane Markers (මාර්ගයේ ඉරි)
            laneMarkers = [];
            const markerGeo = new THREE.PlaneGeometry(0.2, 3);
            const markerMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
            for (let z = 0; z > -100; z -= 6) {
                const marker1 = new THREE.Mesh(markerGeo, markerMat);
                marker1.rotation.x = -Math.PI / 2;
                marker1.position.set(-1, -0.49, z);
                scene.add(marker1);
                laneMarkers.push(marker1);

                const marker2 = new THREE.Mesh(markerGeo, markerMat);
                marker2.rotation.x = -Math.PI / 2;
                marker2.position.set(1, -0.49, z);
                scene.add(marker2);
                laneMarkers.push(marker2);
            }

            // (අලුත්) Buildings (Singapore Skyline)
            buildings = [];
            const buildingGeo = new THREE.BoxGeometry(1, 1, 1);
            for(let i = 0; i < 50; i++) {
                const height = Math.random() * 15 + 5;
                const mat = new THREE.MeshStandardMaterial({ color: 0x555555 });
                const building = new THREE.Mesh(buildingGeo, mat);
                building.scale.set(Math.random() * 2 + 1, height, Math.random() * 2 + 1);
                building.position.set((Math.random() > 0.5 ? 1 : -1) * (Math.random() * 10 + 6), height / 2 - 0.5, -(Math.random() * 100));
                scene.add(building);
                buildings.push(building);
            }


            // Player (Character)
            const playerGeo = new THREE.BoxGeometry(0.6, 1.2, 0.6); // Boy/Girl (Box)
            const playerMat = new THREE.MeshStandardMaterial({ color: selectedPlayerColor });
            player = new THREE.Mesh(playerGeo, playerMat);
            player.position.y = 0.1; // පොළවෙන් මදක් ඉහළට
            player.position.z = 3; 
            player.position.x = lanePositions[currentLane];
            scene.add(player);

            obstacles = [];
            coins = [];

            // 1000ක් වෙනකම් Coins 50 ගානේ spawn කිරීම (වෙනස් කළ)
            for (let i = -10; i > -300; i -= (Math.random() * 10 + 8)) {
                 const rand = Math.random();
                 if (rand < 0.7) {
                     // 70% ක් කාසි spawn කිරීම (කහ)
                     spawnCoin(i);
                 } else {
                     // 30% ක් බාධක spawn කිරීම (වාහන)
                     spawnObstacle(i);
                 }
            }


            // Key controls
            document.addEventListener('keydown', handleKeyPress);

            // Animate
            animate();
        }

        // (වෙනස් කළ) Spawn Obstacles (වාහන)
        function spawnObstacle(zPos) {
            const lane = Math.floor(Math.random() * 3); // 0, 1, or 2
            const isCar = Math.random() > 0.4; // 60% Car, 40% Truck
            
            const geo = isCar ? 
                new THREE.BoxGeometry(1.6, 0.8, 2.5) : // Car shape
                new THREE.BoxGeometry(1.8, 1.8, 3.5); // Truck shape
            
            const mat = new THREE.MeshStandardMaterial({ color: isCar ? 0xf44336 : 0x607d8b }); // රතු Car / අළු Truck
            
            const obstacle = new THREE.Mesh(geo, mat);
            obstacle.position.set(lanePositions[lane], isCar ? -0.1 : 0.4, zPos);
            obstacles.push(obstacle);
            scene.add(obstacle);
        }

        // (වෙනස් කළ) Spawn Coins (Bitcoin)
        function spawnCoin(zPos) {
             const lane = Math.floor(Math.random() * 3); // 0, 1, or 2
             const geo = new THREE.CylinderGeometry(0.3, 0.3, 0.1, 16); // Bitcoin හැඩය
             const mat = new THREE.MeshStandardMaterial({ color: 0xffc107 }); // රන් පාට
             const coin = new THREE.Mesh(geo, mat);
             coin.rotation.x = Math.PI / 2; 
             coin.rotation.z = Math.PI / 2; // $ සලකුණක් නැති නිසා, පැත්තට හරවා තැබීම
             coin.position.set(lanePositions[lane], 0, zPos);
             coins.push(coin);
             scene.add(coin);
        }

        function handleKeyPress(event) {
            if (isGameOver) return;

            if (event.key === 'ArrowLeft') {
                if (currentLane > 0) {
                    currentLane--;
                }
            } else if (event.key === 'ArrowRight') {
                if (currentLane < 2) {
                    currentLane++;
                }
            }
        }
        
        function checkCollision(obj) {
            // AABB Collision Detection
            const playerBox = new THREE.Box3().setFromObject(player);
            const objBox = new THREE.Box3().setFromObject(obj);
            return playerBox.intersectsBox(objBox);
        }

        function animate() {
            if (isGameOver) {
                // Game Over හෝ Win වූ විට, canvas එක render කිරීම නතර කිරීම
                renderer.setAnimationLoop(null);
                return;
            }
            
            requestAnimationFrame(animate);

            // Player's horizontal movement (Smooth)
            player.position.x += (lanePositions[currentLane] - player.position.x) * 0.15; // වේගවත් කළා

            // (අලුත්) Game Speed එක (Difficulty)
            // සෑම කාසි 80කට වරක්ම 0.001 කින් speed එක වැඩි කිරීම
            gameSpeed = 0.05 + (Math.floor(currentGameScore / 80) * 0.001);

            // (අලුත්) මාර්ගයේ ඉරි පස්සට ගෙන යාම
            laneMarkers.forEach(marker => {
                marker.position.z += gameSpeed;
                if(marker.position.z > 5) {
                    marker.position.z = -100; // නැවත මුලට යැවීම
                }
            });
            // (අලුත්) Buildings පස්සට ගෙන යාම
             buildings.forEach(b => {
                b.position.z += gameSpeed * 0.5; // පාරට වඩා සෙමින්
                if(b.position.z > 5) {
                    b.position.z = -100;
                }
            });


            // Move obstacles towards player
            obstacles.forEach((obstacle, index) => {
                obstacle.position.z += gameSpeed;
                // Collision check
                if (obstacle.position.z > 2.5 && obstacle.position.z < 3.5 && checkCollision(obstacle)) {
                    triggerGameOver();
                }
                // Remove if behind player
                if (obstacle.position.z > camera.position.z + 2) {
                    scene.remove(obstacle);
                    obstacles.splice(index, 1);
                    spawnObstacle(-100); // අලුත් බාධකයක් දුරින් spawn කිරීම
                }
            });

            // Move coins towards player
            coins.forEach((coin, index) => {
                coin.position.z += gameSpeed;
                // Coin එක rotate කිරීම
                coin.rotation.z += 0.1; 
                
                // Collision check
                if (coin.position.z > 2.5 && coin.position.z < 3.5 && checkCollision(coin)) {
                    
                    // (වෙනස් කළ) Coin එකතු කිරීම
                    currentGameScore += 1; // එක කාසියකට 1
                    
                    scoreDisplayEl.textContent = 'Score: ' + currentGameScore;
                    scene.remove(coin);
                    coins.splice(index, 1);
                    
                    // (ඉවත් කළ) ලකුණු 1000 පරීක්ෂා කිරීම ඉවත් කළා.
                }
                // Remove if behind player
                if (coin.position.z > camera.position.z + 2) {
                    scene.remove(coin);
                    coins.splice(index, 1);
                    spawnCoin(-100); // අලුත් කාසියක් දුරින් spawn කිරීම
                }
            });
            
            renderer.render(scene, camera);
        }

    </script>
</body>
</html>
