<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Game - DD-Games Money</title>
    <style>
        /* CSS styles (Final Version) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden; /* Stop scrollbars */
            /* Background Image */
            background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT0P4l4azF5XCuejb9u8t7PPnHfEGItqZNZMA&s');
            background-size: cover;
            background-position: center;
        }
        .container {
            background-color: rgba(30, 30, 30, 0.9); /* Semi-transparent background */
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            width: 90vw;
            max-width: 600px; /* Game එකට වැඩි ඉඩක් */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .container h1 {
            margin-top: 0;
            color: #ffc107;
        }
        
        /* Game styles */
        #game-container {
            width: 100%;
            height: 400px; /* Game Canvas එකේ උස */
            background-color: #000;
            margin-top: 1rem;
            border-radius: 8px;
            overflow: hidden;
            display: none; /* --- මුලින් සඟවා තබයි --- */
            position: relative; /* Score එක උඩින් පෙන්වීමට */
        }
        #game-canvas {
            width: 100%;
            height: 100%;
        }
        #score-display {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffc107;
            background-color: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
        /* (අලුත්) Game Over Screen */
        #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* --- මුලින් සඟවා තබයි --- */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 20;
            font-size: 3rem;
            font-weight: bold;
            color: #f44336;
            text-shadow: 2px 2px 8px #000;
        }
        #game-over-screen small {
            font-size: 1.2rem;
            color: #fff;
            margin-top: 10px;
        }

        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; margin: 0.5rem; }
        .btn:hover { background-color: #0069d9; }
        .btn-nav { background-color: #6c757d; }
        .btn-nav:hover { background-color: #5a6268; }
        .btn-girl { background-color: #e91e63; } /* Pink for girl */
        .btn-girl:hover { background-color: #c2185b; }
        
        #message { margin-top: 1rem; font-size: 1.1rem; font-weight: bold; min-height: 20px; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
    </style>
    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Tone.js Library (ශබ්ද සඳහා) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Character Selection UI -->
        <div id="character-select">
            <h1>Endless Runner Game</h1>
            <p>Your Tickets: <strong id="ticket-count">Loading...</strong></p>
            <h3>Select Your Character</h3>
            <button id="select-boy" class="btn">Play as Boy (Blue)</button>
            <button id="select-girl" class="btn btn-girl">Play as Girl (Pink)</button>
            <div id="message"></div>
            <!-- (Fixed Path) -->
            <button id="wallet-btn" class="btn btn-nav" style="margin-top: 20px;">Go to Wallet</button>
        </div>

        <!-- The Actual Game Area -->
        <div id="game-container">
            <canvas id="game-canvas"></canvas>
            <div id="score-display">Score: 0</div>
            <!-- Game Over Screen -->
            <div id="game-over-screen">
                GAME OVER
                <small id="game-over-score"></small>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Global Variables & Auth ---
        const token = localStorage.getItem('ddUserToken');
        const authHeaders = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };
        
        // Element cache
        const messageEl = document.getElementById('message');
        const ticketCountEl = document.getElementById('ticket-count');
        const gameContainerEl = document.getElementById('game-container');
        const scoreDisplayEl = document.getElementById('score-display').firstChild;
        const walletBtn = document.getElementById('wallet-btn');
        
        const characterSelectEl = document.getElementById('character-select');
        const selectBoyBtn = document.getElementById('select-boy');
        const selectGirlBtn = document.getElementById('select-girl');
        const gameOverScreenEl = document.getElementById('game-over-screen');
        const gameOverScoreEl = document.getElementById('game-over-score');

        let currentGameScore = 0;
        let isGameOver = false;
        let playerColor = '#007bff'; // Default to Boy (Blue)
        let gameSpeed = 0.05;

        // Sound variables
        let bgMusic, gameOverSound;

        // --- 2. Initial Data Load & Sound Setup ---
        window.addEventListener('DOMContentLoaded', async () => {
            if (!token) {
                window.location.href = '/login.html'; // (Fixed Path)
                return;
            }
            
            // Setup Sounds (Browser AutoPlay Policy නිසා, start() function එක user click එකෙන් පසුවයි)
            bgMusic = new Tone.Loop(time => {
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C2", "8n", time);
                synth.triggerAttackRelease("G2", "8n", time + 0.5);
            }, "1n");
            
            gameOverSound = new Tone.Synth().toDestination();
            
            // Fetch user data
            try {
                // (Fixed Path)
                const response = await fetch('/api/user-data', {
                    method: 'GET', headers: authHeaders
                });
                if (response.ok) {
                    const data = await response.json();
                    ticketCountEl.textContent = data.tickets;
                } else {
                    localStorage.removeItem('ddUserToken');
                    window.location.href = '/login.html'; // (Fixed Path)
                }
            } catch (error) { 
                console.error('Error fetching user data:', error);
                messageEl.className = 'error';
                messageEl.textContent = 'Error loading user data.';
            }
        });

        // --- 3. Character Selection ---
        selectBoyBtn.addEventListener('click', () => {
            playerColor = '#007bff'; // Boy (Blue)
            spendTicketAndStartGame();
        });
        selectGirlBtn.addEventListener('click', () => {
            playerColor = '#e91e63'; // Girl (Pink)
            spendTicketAndStartGame();
        });

        // --- 4. Spend Ticket & Start Game ---
        async function spendTicketAndStartGame() {
            // (Sound Fix) User ගේ පළමු click එකෙන් Tone.start() කිරීම
            await Tone.start();
            messageEl.textContent = 'Spending 1 ticket...';
            
            try {
                // (Fixed Path)
                const response = await fetch('/api/spend-ticket', {
                    method: 'POST', headers: authHeaders
                });
                const data = await response.json();

                if (response.ok) {
                    messageEl.className = 'success';
                    messageEl.textContent = data.message;
                    ticketCountEl.textContent = data.newTicketCount;
                    
                    // --- ක්‍රීඩාව ආරම්භ කිරීම ---
                    startGame();
                } else {
                    messageEl.className = 'error';
                    messageEl.textContent = `Error: ${data.message}`;
                }
            } catch (error) {
                messageEl.className = 'error';
                messageEl.textContent = 'Could not connect to the server.';
            }
        }

        // --- 5. startGame (UI) ---
        function startGame() {
            currentGameScore = 0;
            isGameOver = false;
            gameSpeed = 0.05; // Game speed එක reset කිරීම
            scoreDisplayEl.textContent = 'Score: 0';
            
            characterSelectEl.style.display = 'none'; // Character select සඟවා තැබීම
            gameContainerEl.style.display = 'block'; // Game එක පෙන්වීම
            gameOverScreenEl.style.display = 'none'; // Game Over තිරය සඟවා තැබීම
            messageEl.textContent = ''; // පරණ messages clear කිරීම
            
            // --- (Black Screen Fix) ---
            // 3D Game Logic එක, browser එකේ ඊළඟ frame එකේදී ආරම්භ කිරීම
            // මෙය browser එකට container එකේ size (width/height) එක ගණනය කිරීමට කාලය ලබා දේ
            requestAnimationFrame(() => {
                init3DGame(playerColor); // <<<--- 3D Game Logic එක ආරම්භ කිරීම
            });
            
            // Start Background Music
            Tone.Transport.start();
            bgMusic.start(0);
        }

        // --- 6. Go to Wallet Button ---
        walletBtn.addEventListener('click', () => {
            window.location.href = '/wallet.html'; // (Fixed Path)
        });

        // --- 7. Game Over (බාධකයක වැදුනොත්) ---
        function triggerGameOver() {
            if (isGameOver) return; // Game over දැනටමත් සිදුවී ඇත්නම්, නැවත නොකිරීම
            isGameOver = true;
            
            // Stop Music & Play Game Over Sound
            bgMusic.stop();
            Tone.Transport.stop();
            gameOverSound.triggerAttackRelease("C3", "0.5s");
            gameOverSound.triggerAttackRelease("G2", "0.5s", "+0.1s");
            gameOverSound.triggerAttackRelease("C2", "1s", "+0.2s");
            
            // Show Game Over Screen
            gameOverScoreEl.textContent = `Final Score: ${currentGameScore}`;
            gameOverScreenEl.style.display = 'flex'; // Game Over තිරය පෙන්වීම
            
            // Post Score to Wallet (Coins = LKR)
            if (currentGameScore > 0) {
                postScoreToWallet(currentGameScore);
            } else {
                 messageEl.textContent = 'Game Over!';
            }

            // 3 seconds පසු, Character Select තිරයට ආපසු යැවීම
            setTimeout(() => {
                characterSelectEl.style.display = 'block';
                gameContainerEl.style.display = 'none';
                // (අලුත්) පිටුව reload කිරීමෙන් 3D game එක සම්පූර්ණයෙන්ම reset කිරීම
                window.location.reload(); 
            }, 3000); // තත්පර 3කට පසු
        }

        // --- 8. Post Score (Coins) to Wallet Balance ---
        async function postScoreToWallet(score) {
            messageEl.className = 'success';
            messageEl.textContent = `Game Over! Adding ${score} coins to your wallet balance...`;

            try {
                // (Fixed Path)
                // අපි /api/reload endpoint එකම Coins = LKR ලෙස භාවිතා කරමු
                const response = await fetch('/api/reload', {
                    method: 'POST',
                    headers: authHeaders,
                    body: JSON.stringify({ amount: score }) // Final Score එක Amount එක ලෙස යැවීම
                });
                const data = await response.json();

                if (response.ok) {
                    gameOverScoreEl.textContent = `Final Score: ${score}. Added to wallet!`;
                    messageEl.textContent = `Successfully added ${score} coins to your balance.`;
                } else {
                    messageEl.textContent = `Error: ${data.message}`;
                }
            } catch (error) {
                messageEl.className = 'error';
                messageEl.textContent = 'Could not save score to wallet.';
            }
        }


        // ******************************************************
        // --- 9. THREE.JS 3D GAME LOGIC (Final Fix) ---
        // ******************************************************
        let scene, camera, renderer, player, lanes, obstacles, coins, laneMarkers, buildings;
        const lanePositions = [-2, 0, 2]; // Lane positions (වම්, මැද, දකුණු)
        let currentLane = 1; // 0=වම්, 1=මැද, 2=දකුණු

        function init3DGame(selectedPlayerColor) {
            // (Black Screen Fix) Canvas සහ Container Dimensions නිවැරදිව ලබා ගැනීම
            const canvas = document.getElementById('game-canvas');
            const rect = gameContainerEl.getBoundingClientRect(); // <<<--- මෙන්න නිවැරදි කිරීම
            const width = rect.width;
            const height = rect.height;

            // --- Scene Setup ---
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2a); // "Singapore" (Night City)
            scene.fog = new THREE.Fog(0x1a1a2a, 10, 30); // දුරස්ථභාවය (Fog)
            
            // --- Camera ---
            // (Fix) Camera එකට නිවැරදි dimensions (width/height) ලබා දීම
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.set(0, 1.5, 4); // x, y, z
            camera.lookAt(0, 1, 0);
            
            // --- Renderer ---
            // (Fix) Renderer එකට නිවැරදි dimensions (width/height) ලබා දීම
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(width, height);
            
            // --- Lights ---
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(2, 5, 5);
            scene.add(dirLight);
            // Player's "Headlight"
            const headLight = new THREE.SpotLight(0xffffff, 1, 20, Math.PI / 4, 0.5);
            headLight.position.set(0, 0.5, 3.5); // Player ඉදිරියෙන්
            
            // --- Ground / Highway ---
            const groundGeo = new THREE.PlaneGeometry(10, 100); // (Highway)
            const groundMat = new THREE.MeshStandardMaterial({ color: 0x333333 }); 
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.5;
            scene.add(ground);
            
            // Lane Markers (මාර්ගයේ ඉරි)
            laneMarkers = [];
            const markerGeo = new THREE.PlaneGeometry(0.2, 3);
            const markerMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
            for (let z = 0; z > -100; z -= 6) {
                const marker1 = new THREE.Mesh(markerGeo, markerMat);
                marker1.rotation.x = -Math.PI / 2;
                marker1.position.set(-1, -0.49, z);
                scene.add(marker1);
                laneMarkers.push(marker1);
                const marker2 = new THREE.Mesh(markerGeo, markerMat);
                marker2.rotation.x = -Math.PI / 2;
                marker2.position.set(1, -0.49, z);
                scene.add(marker2);
                laneMarkers.push(marker2);
            }

            // Buildings (City)
            buildings = [];
            const buildingGeo = new THREE.BoxGeometry(1, 1, 1);
            for(let i = 0; i < 50; i++) {
                const height = Math.random() * 15 + 5;
                const mat = new THREE.MeshStandardMaterial({ color: 0x555555 }); // City color
                const building = new THREE.Mesh(buildingGeo, mat);
                building.scale.set(Math.random() * 2 + 1, height, Math.random() * 2 + 1);
                building.position.set((Math.random() > 0.5 ? 1 : -1) * (Math.random() * 10 + 6), height / 2 - 0.5, -(Math.random() * 100));
                scene.add(building);
                buildings.push(building);
            }

            // --- Player (Boy/Girl) ---
            // (Boy = 0.6x1.2x0.6 Blue Box, Girl = 0.5x1.0x0.5 Pink Box)
            const playerGeo = (selectedPlayerColor === '#e91e63') ? 
                new THREE.BoxGeometry(0.5, 1.0, 0.5) : // Girl (Pink)
                new THREE.BoxGeometry(0.6, 1.2, 0.6); // Boy (Blue)
            const playerMat = new THREE.MeshStandardMaterial({ color: selectedPlayerColor });
            player = new THREE.Mesh(playerGeo, playerMat);
            player.position.y = (selectedPlayerColor === '#e91e63') ? 0.0 : 0.1; // Girl is shorter
            player.position.z = 3; 
            player.position.x = lanePositions[currentLane];
            scene.add(player);
            headLight.target = player; // Headlight එක Player ව follow කිරීම
            scene.add(headLight);

            // --- Obstacles and Coins ---
            obstacles = [];
            coins = [];
            
            // Objects spawn කිරීම
            for (let i = -10; i > -300; i -= (Math.random() * 10 + 8)) {
                 const rand = Math.random();
                 if (rand < 0.7) {
                     spawnCoin(i); // 70% chance for coin
                 } else {
                     spawnObstacle(i); // 30% chance for obstacle
                 }
            }
            
            // Key controls
            document.addEventListener('keydown', handleKeyPress);

            // Animate
            // (Fix) renderer.setAnimationLoop() භාවිතා කිරීම (requestAnimationFrame() වෙනුවට)
            renderer.setAnimationLoop(animate);
        }

        // Obstacle (Cars/Trucks) Spawn කිරීම
        function spawnObstacle(zPos) {
            const lane = Math.floor(Math.random() * 3); // 0, 1, or 2
            const isCar = Math.random() > 0.4; // 60% Car, 40% Truck
            const geo = isCar ? 
                new THREE.BoxGeometry(1.6, 0.8, 2.5) : // Car shape
                new THREE.BoxGeometry(1.8, 1.8, 3.5); // Truck shape
            const mat = new THREE.MeshStandardMaterial({ color: isCar ? 0xf44336 : 0x607d8b }); // Red Car / Grey Truck
            const obstacle = new THREE.Mesh(geo, mat);
            obstacle.position.set(lanePositions[lane], isCar ? -0.1 : 0.4, zPos);
            obstacles.push(obstacle);
            scene.add(obstacle);
        }

        // Coin (Bitcoin) Spawn කිරීම
        function spawnCoin(zPos) {
             const lane = Math.floor(Math.random() * 3); 
             const geo = new THREE.CylinderGeometry(0.3, 0.3, 0.1, 16); // Bitcoin shape
             const mat = new THREE.MeshStandardMaterial({ color: 0xffc107 }); // Gold color
             const coin = new THREE.Mesh(geo, mat);
             coin.rotation.x = Math.PI / 2; // Bitcoin එක හරවා තැබීම
             coin.rotation.z = Math.PI / 2; // (මෙහි $ ලකුණ දැමීම texturing නොමැතිව කළ නොහැක)
             coin.position.set(lanePositions[lane], 0, zPos);
             coins.push(coin);
             scene.add(coin);
        }

        // Key Press handler
        function handleKeyPress(event) {
            if (isGameOver) return;
            // Move Left
            if (event.key === 'ArrowLeft') {
                if (currentLane > 0) {
                    currentLane--;
                }
            } 
            // Move Right
            else if (event.key === 'ArrowRight') {
                if (currentLane < 2) {
                    currentLane++;
                }
            }
        }
        
        // Collision (ගැටුම්) පරීක්ෂා කිරීම
        function checkCollision(obj) {
            if (!player || !obj) return false;
            // AABB Collision Detection
            const playerBox = new THREE.Box3().setFromObject(player);
            const objBox = new THREE.Box3().setFromObject(obj);
            return playerBox.intersectsBox(objBox);
        }

        // --- 10. Animation Loop (Game Engine) ---
        function animate() {
            // (Fix) isGameOver වූ විට, loop එක renderer එකෙන්ම නතර කිරීම
            if (isGameOver) {
                renderer.setAnimationLoop(null);
                return;
            }
            
            // Player's horizontal movement (Smooth)
            player.position.x += (lanePositions[currentLane] - player.position.x) * 0.15; // 0.15 = speed
            
            // Game Speed (Difficulty) - (ඔබගේ ඉල්ලීම පරිදි)
            // සෑම කාසි 80කට වරක්ම 0.001 කින් වේගය වැඩි කිරීම
            gameSpeed = 0.05 + (Math.floor(currentGameScore / 80) * 0.001);

            // Move Lane Markers
            laneMarkers.forEach(marker => {
                marker.position.z += gameSpeed;
                if(marker.position.z > 5) {
                    marker.position.z = -100; // නැවත පිටුපසට යැවීම
                }
            });
            
            // Move Buildings
             buildings.forEach(b => {
                b.position.z += gameSpeed * 0.5; // මාර්ගයට වඩා සෙමින්
                if(b.position.z > 5) {
                    b.position.z = -100;
                }
            });

            // Move Obstacles (වාහන)
            obstacles.forEach((obstacle, index) => {
                obstacle.position.z += gameSpeed;
                
                // Collision check (Player ට ආසන්න වූ විට පමණක්)
                if (obstacle.position.z > 2.5 && obstacle.position.z < 3.5 && checkCollision(obstacle)) {
                    triggerGameOver();
                }
                
                // Camera එක පසු කළ පසු, object එක ඉවත් කර, අලුත් එකක් spawn කිරීම
                if (obstacle.position.z > camera.position.z + 2) {
                    scene.remove(obstacle);
                    obstacles.splice(index, 1);
                    spawnObstacle(-100); // ඈතින් අලුත් බාධකයක්
                }
            });

            // Move Coins
            coins.forEach((coin, index) => {
                coin.position.z += gameSpeed;
                coin.rotation.z += 0.1; // Coin එක කරකැවීම
                
                // Collision check (Player ට ආසන්න වූ විට පමණක්)
                if (coin.position.z > 2.5 && coin.position.z < 3.5 && checkCollision(coin)) {
                    currentGameScore += 1; // (ඔබගේ ඉල්ලීම: 1 per coin)
                    scoreDisplayEl.textContent = 'Score: ' + currentGameScore;
                    scene.remove(coin);
                    coins.splice(index, 1);
                    // (ලකුණු 1000දී නතර කිරීමේ කේතය ඉවත් කර ඇත)
                }
                
                // Camera එක පසු කළ පසු, object එක ඉවත් කර, අලුත් එකක් spawn කිරීම
                if (coin.position.z > camera.position.z + 2) {
                    scene.remove(coin);
                    coins.splice(index, 1);
                    spawnCoin(-100); // ඈතින් අලුත් කාසියක්
                }
            });
            
            // Render the scene
            renderer.render(scene, camera);
        }

    </script>
</body>
</html>
